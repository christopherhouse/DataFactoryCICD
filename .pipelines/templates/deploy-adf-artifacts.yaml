parameters:
- name: stageName
  default: ''
- name: environment
  default: ''
- name: serviceConnection
  default: ''
- name: resourceGroupName
  default: ''
- name: dataFactoryName
  default: ''
- name: archiveStorageConnectionStringSecretName
  default: ''
- name: orderStorageConnectionStringSecretName
  default: ''
- name: keyVaultBaseUrl
  default: ''

stages:
- stage: ${{ parameters.stageName }}
  displayName: ${{ parameters.stageName }}
  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: ${{ parameters.environment }}
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            displayName: Download adf_publish artifact
            artifact: adf_publish

          - downlaod: current
            displayName: Download scripts artifact
            artifact: scripts
        
          - task: AzurePowerShell@5
            displayName: Stop ADF triggers
            inputs:
              azureSubscription: ${{ parameters.serviceConnection }}
              ScriptType: FilePath
              ScriptPath: $(Pipeline.Workspace)/scripts/adfPreAndPostDeployOps.ps1
              ScriptArgumnets: -armTemplate $(Pipeline.Workspace)/adf_publish/ARMTemplateForFactory.json -ResourceGroupName ${{ parameters.resourceGroupName }} -DataFactoryName ${{ parameters.dataFactoryName }} -predeployment $true -deleteDeployment $false
              azurePowerShellVersion: Latest
